<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/x-icon" href="static/favicon.ico"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="author" content="Matt Faulkner">
    <meta name="robots" content="noindex, nofollow"> <!--Discourage Search Engine Indexing of this page-->
    <meta name="theme-color" content="#284389"> <!-- Mobile Browser stylized address bar.-->
    <meta http-equiv="X-UA-Compatible" content="IE=edge"> <!-- Force IE to use latest rendering engine available.-->
    <meta http-equiv="refresh" content="600"> <!-- 10 Minute Page Refresh -->
    <title>GoobyDesk - Technician Dashboard</title>
    <!-- Performance Enhancements -->
    <link rel="preconnect" href="https://fonts.bunny.net/css">
    <link rel="preconnect" href="https://fonts.bunny.net/css" crossorigin>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <!-- Style/CSS goes in the HTML5 head -->
    <!-- <style></style> -->
</head>
<!-- Start of the displayed HTML -->
<body>
    <div class="container">
        <div class="logo">
            <img src="https://raw.githubusercontent.com/GoobyFRS/GoobyDesk/refs/heads/main/static/GoobyDesk-color.webp" alt=" GoobyDesk Logo">
        </div>
        <h2>GoobyDesk Technician Dashboard</h2>
        <ul class="ticket-list">
            {% for ticket in tickets %}
                <li>
                    <a href="{{ url_for('ticket_detail', ticket_number=ticket.ticket_number) }}">
                        {{ ticket.ticket_number }} - {{ ticket.ticket_subject }} ({{ ticket.ticket_status }})
                    </a>
                </li>
            {% endfor %}
        </ul>
        <!-- Close Ticket button -->
        <div>
            <input type="text" id="ticketIdInput" placeholder="Ticket Number">
            <button class="close-ticket-btn" button onclick="closeTicket()">Close Ticket</button>
        </div>
        <!-- Below is the Javascript required for the close ticket button. -->
        <script>
            async function updateTicketStatus(ticketId, newStatus) { // Reusable function for status updates
                ticketId = ticketId.trim();
        
                if (!ticketId) {
                    alert("Ticket Number was NOT found. Try again.");
                    return;
                }
        
                try {
                    let response = await fetch(`/ticket/${ticketId}/update_status/${newStatus}`, {
                        method: "POST",
                        headers: { "Accept": "application/json" }
                    });
        
                    if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
        
                    let data = await response.json();
                    alert(data.message);
                    location.reload();  // Refresh dashboard after updating ticket.
                } catch (error) {
                    console.error("Error:", error);
                    alert("An error occurred while updating the ticket. Please try again.");
                }
            }
        
            function closeTicket() {
                let ticketId = document.getElementById("ticketIdInput").value;
                updateTicketStatus(ticketId, "Closed");
            }
        </script>
        
        <!-- Technician logout button -->
        <a href="{{ url_for('logout') }}" class="logout-btn">Logout</a>
        <!-- Footer Text -->
        <p class="footer-text">Â©2025 GoobyDesk, FOSS created by <a href="https://github.com/goobyfrs">GoobyFRS</a> | Logged In as: {{ loggedInTech }} | BuildID: {{ BUILDID }}</p>
    </div>
</body>
</html>
